<script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.40.0",
    "lucide-react": "https://esm.sh/lucide-react@^0.563.0",
    "canvas-confetti": "https://esm.sh/canvas-confetti@^1.9.4"
  }
}
</script>

let audioCtx: AudioContext | null = null;

const initAudio = () => {
  if (!audioCtx) audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
};

const playTone = (freq: number, type: OscillatorType, duration: number, volume: number, startTime: number = 0) => {
  initAudio();
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type;
  osc.frequency.setValueAtTime(freq, audioCtx.currentTime + startTime);
  gain.gain.setValueAtTime(volume, audioCtx.currentTime + startTime);
  gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + startTime + duration);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start(audioCtx.currentTime + startTime);
  osc.stop(audioCtx.currentTime + startTime + duration);
};

export const playDrawSound = () => playTone(440, 'sine', 0.15, 0.1);
export const playMarkSound = () => playTone(880, 'sine', 0.05, 0.05);

export const playWinSound = () => {
  initAudio();
  if (!audioCtx) return;
  const now = audioCtx.currentTime;
  const notes = [523.25, 659.25, 783.99, 1046.50];
  notes.forEach((freq, i) => {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(freq, now + i * 0.15);
    gain.gain.setValueAtTime(0.1, now + i * 0.15);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + i * 0.15 + 0.5);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(now + i * 0.15);
    osc.stop(now + i * 0.15 + 0.5);
  });
};

export const playTriumphantFanfare = () => {
  initAudio();
  if (!audioCtx) return;
  const notes = [
    { f: 523.25, d: 0.3, s: 0 },   // C5
    { f: 523.25, d: 0.3, s: 0.3 }, // C5
    { f: 523.25, d: 0.3, s: 0.6 }, // C5
    { f: 698.46, d: 0.8, s: 0.9 }, // F5
    { f: 880.00, d: 0.8, s: 1.7 }, // A5
    { f: 1046.50, d: 1.5, s: 2.5 } // C6
  ];
  
  notes.forEach(n => {
    playTone(n.f, 'square', n.d, 0.08, n.s);
    playTone(n.f * 1.01, 'sawtooth', n.d, 0.04, n.s); // Add some thickness
  });
};
